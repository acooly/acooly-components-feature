var detailview=$.extend({},$.fn.datagrid.defaults.view,{render:function(target,container,frozen){var state=$.data(target,"datagrid");var opts=state.options;if(frozen){if(!(opts.rownumbers||opts.frozenColumns&&opts.frozenColumns.length)){return}}var rows=state.data.rows;var fields=$(target).datagrid("getColumnFields",frozen);var table=[];table.push('<table class="datagrid-btable" cellspacing="0" cellpadding="0" border="0"><tbody>');for(var i=0;i<rows.length;i++){var cls=i%2&&opts.striped?'class="datagrid-row datagrid-row-alt"':'class="datagrid-row"';var styleValue=opts.rowStyler?opts.rowStyler.call(target,i,rows[i]):"";var style=styleValue?'style="'+styleValue+'"':"";var rowId=state.rowIdPrefix+"-"+(frozen?1:2)+"-"+i;table.push('<tr id="'+rowId+'" datagrid-row-index="'+i+'" '+cls+" "+style+">");table.push(this.renderRow.call(this,target,fields,frozen,i,rows[i]));table.push("</tr>");table.push('<tr style="display:none;">');if(frozen){table.push("<td colspan="+(fields.length+2)+' style="border-right:0">')}else{table.push("<td colspan="+fields.length+">")}table.push('<div class="datagrid-row-detail">');if(frozen){table.push("&nbsp;")}else{table.push(opts.detailFormatter.call(target,i,rows[i]))}table.push("</div>");table.push("</td>");table.push("</tr>")}table.push("</tbody></table>");$(container).html(table.join(""))},renderRow:function(target,fields,frozen,rowIndex,rowData){var opts=$.data(target,"datagrid").options;var cc=[];if(frozen&&opts.rownumbers){var rownumber=rowIndex+1;if(opts.pagination){rownumber+=(opts.pageNumber-1)*opts.pageSize}cc.push('<td class="datagrid-td-rownumber"><div class="datagrid-cell-rownumber">'+rownumber+"</div></td>")}for(var i=0;i<fields.length;i++){var field=fields[i];var col=$(target).datagrid("getColumnOption",field);if(col){var value=rowData[field];var styleValue=col.styler?col.styler(value,rowData,rowIndex)||"":"";var style=col.hidden?'style="display:none;'+styleValue+'"':styleValue?'style="'+styleValue+'"':"";cc.push('<td field="'+field+'" '+style+">");if(col.checkbox){var style=""}else{var style=styleValue;if(col.align){style+=";text-align:"+col.align+";"}if(!opts.nowrap){style+=";white-space:normal;height:auto;"}else if(opts.autoRowHeight){style+=";height:auto;"}}cc.push('<div style="'+style+'" ');if(col.checkbox){cc.push('class="datagrid-cell-check ')}else{cc.push('class="datagrid-cell '+col.cellClass)}cc.push('">');if(col.checkbox){cc.push('<input type="checkbox" name="'+field+'" value="'+(value!=undefined?value:"")+'"/>')}else if(col.expander){cc.push('<span class="datagrid-row-expander datagrid-row-expand" style="display:inline-block;width:16px;height:16px;cursor:pointer;" />')}else if(col.formatter){var orgdata=$.data(target,"datagrid").data;cc.push(col.formatter(value,rowData,rowIndex,orgdata,field))}else{cc.push(value)}cc.push("</div>");cc.push("</td>")}}return cc.join("")},insertRow:function(target,index,row){var opts=$.data(target,"datagrid").options;var dc=$.data(target,"datagrid").dc;var panel=$(target).datagrid("getPanel");var view1=dc.view1;var view2=dc.view2;var isAppend=false;var rowLength=$(target).datagrid("getRows").length;if(rowLength==0){$(target).datagrid("loadData",{total:1,rows:[row]});return}if(index==undefined||index==null||index>=rowLength){index=rowLength;isAppend=true;this.canUpdateDetail=false}$.fn.datagrid.defaults.view.insertRow.call(this,target,index,row);_insert(true);_insert(false);this.canUpdateDetail=true;function _insert(frozen){var v=frozen?view1:view2;var tr=v.find("tr[datagrid-row-index="+index+"]");if(isAppend){var newDetail=tr.next().clone()}else{var newDetail=tr.next().next().clone()}newDetail.insertAfter(tr);newDetail.hide();if(!frozen){newDetail.find("div.datagrid-row-detail").html(opts.detailFormatter.call(target,index,row))}}},deleteRow:function(target,index){var opts=$.data(target,"datagrid").options;var dc=$.data(target,"datagrid").dc;var tr=opts.finder.getTr(target,index);tr.next().remove();$.fn.datagrid.defaults.view.deleteRow.call(this,target,index);dc.body2.triggerHandler("scroll")},updateRow:function(target,rowIndex,row){var dc=$.data(target,"datagrid").dc;var opts=$.data(target,"datagrid").options;var cls=$(target).datagrid("getExpander",rowIndex).attr("class");$.fn.datagrid.defaults.view.updateRow.call(this,target,rowIndex,row);$(target).datagrid("getExpander",rowIndex).attr("class",cls);if(this.canUpdateDetail){var row=$(target).datagrid("getRows")[rowIndex];var detail=$(target).datagrid("getRowDetail",rowIndex);detail.html(opts.detailFormatter.call(target,rowIndex,row))}},bindEvents:function(target){var state=$.data(target,"datagrid");var dc=state.dc;var opts=state.options;var body=dc.body1.add(dc.body2);var clickHandler=($.data(body[0],"events")||$._data(body[0],"events")).click[0].handler;body.unbind("click").bind("click",function(e){var tt=$(e.target);var tr=tt.closest("tr.datagrid-row");if(!tr.length){return}if(tt.hasClass("datagrid-row-expander")){var rowIndex=parseInt(tr.attr("datagrid-row-index"));if(tt.hasClass("datagrid-row-expand")){$(target).datagrid("expandRow",rowIndex)}else{$(target).datagrid("collapseRow",rowIndex)}$(target).datagrid("fixRowHeight")}else{clickHandler(e)}e.stopPropagation()})},onBeforeRender:function(target){var state=$.data(target,"datagrid");var opts=state.options;var dc=state.dc;var t=$(target);var hasExpander=false;var fields=t.datagrid("getColumnFields",true).concat(t.datagrid("getColumnFields"));for(var i=0;i<fields.length;i++){var col=t.datagrid("getColumnOption",fields[i]);if(col.expander){hasExpander=true;break}}if(!hasExpander){if(opts.frozenColumns&&opts.frozenColumns.length){opts.frozenColumns[0].splice(0,0,{field:"_expander",expander:true})}else{opts.frozenColumns=[[{field:"_expander",expander:true}]]}var t=dc.view1.children("div.datagrid-header").find("table");var td=$('<td rowspan="'+opts.frozenColumns.length+'"><div class="datagrid-header-expander" style="width:24px;"></div></td>');if($("tr",t).length==0){td.wrap("<tr></tr>").parent().appendTo($("tbody",t))}else if(opts.rownumbers){td.insertAfter(t.find("td:has(div.datagrid-header-rownumber)"))}else{td.prependTo(t.find("tr:first"))}}var that=this;setTimeout(function(){that.bindEvents(target)},0)},onAfterRender:function(target){var that=this;var state=$.data(target,"datagrid");var dc=state.dc;var opts=state.options;var panel=$(target).datagrid("getPanel");$.fn.datagrid.defaults.view.onAfterRender.call(this,target);if(!state.onResizeColumn){state.onResizeColumn=opts.onResizeColumn}if(!state.onResize){state.onResize=opts.onResize}function setBodyTableWidth(){var columnWidths=dc.view2.children("div.datagrid-header").find("table").width();dc.body2.children("table").width(columnWidths)}opts.onResizeColumn=function(field,width){setBodyTableWidth();var rowCount=$(target).datagrid("getRows").length;for(var i=0;i<rowCount;i++){$(target).datagrid("fixDetailRowHeight",i)}state.onResizeColumn.call(target,field,width)};opts.onResize=function(width,height){setBodyTableWidth();state.onResize.call(panel,width,height)};this.canUpdateDetail=true;dc.footer1.find("span.datagrid-row-expander").css("visibility","hidden");$(target).datagrid("resize")}});$.extend($.fn.datagrid.methods,{fixDetailRowHeight:function(jq,index){return jq.each(function(){var opts=$.data(this,"datagrid").options;if(!(opts.rownumbers||opts.frozenColumns&&opts.frozenColumns.length)){return}var dc=$.data(this,"datagrid").dc;var tr1=opts.finder.getTr(this,index,"body",1).next();var tr2=opts.finder.getTr(this,index,"body",2).next();if(tr2.is(":visible")){tr1.css("height","");tr2.css("height","");var height=Math.max(tr1.height(),tr2.height());tr1.css("height",height);tr2.css("height",height)}dc.body2.triggerHandler("scroll")})},getExpander:function(jq,index){var opts=$.data(jq[0],"datagrid").options;return opts.finder.getTr(jq[0],index).find("span.datagrid-row-expander")},getRowDetail:function(jq,index){var opts=$.data(jq[0],"datagrid").options;var tr=opts.finder.getTr(jq[0],index,"body",2);return tr.next().find("div.datagrid-row-detail")},expandRow:function(jq,index){return jq.each(function(){var opts=$(this).datagrid("options");var dc=$.data(this,"datagrid").dc;var expander=$(this).datagrid("getExpander",index);if(expander.hasClass("datagrid-row-expand")){expander.removeClass("datagrid-row-expand").addClass("datagrid-row-collapse");var tr1=opts.finder.getTr(this,index,"body",1).next();var tr2=opts.finder.getTr(this,index,"body",2).next();tr1.show();tr2.show();$(this).datagrid("fixDetailRowHeight",index);if(opts.onExpandRow){var row=$(this).datagrid("getRows")[index];opts.onExpandRow.call(this,index,row)}}})},collapseRow:function(jq,index){return jq.each(function(){var opts=$(this).datagrid("options");var dc=$.data(this,"datagrid").dc;var expander=$(this).datagrid("getExpander",index);if(expander.hasClass("datagrid-row-collapse")){expander.removeClass("datagrid-row-collapse").addClass("datagrid-row-expand");var tr1=opts.finder.getTr(this,index,"body",1).next();var tr2=opts.finder.getTr(this,index,"body",2).next();tr1.hide();tr2.hide();dc.body2.triggerHandler("scroll");if(opts.onCollapseRow){var row=$(this).datagrid("getRows")[index];opts.onCollapseRow.call(this,index,row)}}})}});(function($){$.extend($.fn.datagrid.defaults,{dropAccept:"tr.datagrid-row",dragSelection:false,dragDelay:100,onBeforeDrag:function(row){},onStartDrag:function(row){},onStopDrag:function(row){},onDragEnter:function(targetRow,sourceRow){},onDragOver:function(targetRow,sourceRow){},onDragLeave:function(targetRow,sourceRow){},onBeforeDrop:function(targetRow,sourceRow,point){},onDrop:function(targetRow,sourceRow,point){}});$.extend($.fn.datagrid.methods,{_appendRows:function(jq,row){return jq.each(function(){var dg=$(this);var rows=$.isArray(row)?row:[row];$.map(rows,function(row){dg.datagrid("appendRow",row).datagrid("enableDnd",dg.datagrid("getRows").length-1)})})},_insertRows:function(jq,param){return jq.each(function(){var dg=$(this);var index=param.index;var row=param.row;var rows=$.isArray(row)?row:[row];$.map(rows,function(row,i){dg.datagrid("insertRow",{index:index+i,row:row}).datagrid("enableDnd",index+i)})})},_getRowIndexs:function(jq,row){var dg=jq;var rows=$.isArray(row)?row:[row];var indexs=$.map(rows,function(row){return dg.datagrid("getRowIndex",row)});return $.grep(indexs,function(index){if(index>=0){return true}})},_deleteRows:function(jq,indexs){return jq.each(function(){indexs.sort(function(x,y){if(parseInt(x)>parseInt(y)){return-1}else{return 1}});for(var i=0;i<indexs.length;i++){$(this).datagrid("deleteRow",indexs[i])}})},_setSelections:function(jq){return jq.each(function(){var rows=$(this).datagrid("getRows");for(var i=0;i<rows.length;i++){if(rows[i]._selected){$(this).datagrid("selectRow",i);rows[i]._selected=undefined}}})},clearInsertingFlag:function(jq){return jq.each(function(){var opts=$(this).datagrid("options");if(opts.insertingIndex>=0){var tr=opts.finder.getTr(this,opts.insertingIndex);tr.removeClass("datagrid-row-top datagrid-row-bottom");opts.insertingIndex=-1}})}});var disabledDroppingRows=[];function enableDroppable(aa){$.map(aa,function(row){$(row).droppable("enable")})}$.extend($.fn.datagrid.methods,{resetDroppable:function(jq){return jq.each(function(){var c=$(this).datagrid("getPanel")[0];var my=[];var left=[];for(var i=0;i<disabledDroppingRows.length;i++){var t=disabledDroppingRows[i];var p=$(t).closest("div.datagrid-wrap");if(p.length&&p[0]==c){my.push(t)}else{left.push(t)}}disabledDroppingRows=left;enableDroppable(my)})},enableDnd:function(jq,index){if(!$("#datagrid-dnd-style").length){$('<style id="datagrid-dnd-style">'+".datagrid-row-top>td{border-top:1px solid red}"+".datagrid-row-bottom>td{border-bottom:1px solid red}"+"</style>").appendTo("head")}return jq.each(function(){var target=this;var state=$.data(this,"datagrid");var dg=$(this);var opts=state.options;var draggableOptions={disabled:false,revert:true,cursor:"pointer",proxy:function(source){var p=$('<div style="z-index:9999999999999"></div>').appendTo("body");var draggingRow=getDraggingRow(source);var rows=$.isArray(draggingRow)?draggingRow:[draggingRow];$.map(rows,function(row,i){var index=dg.datagrid("getRowIndex",row);var tr1=opts.finder.getTr(target,index,"body",1);var tr2=opts.finder.getTr(target,index,"body",2);tr2.clone().removeAttr("id").removeClass("droppable").appendTo(p);tr1.clone().removeAttr("id").removeClass("droppable").find("td").insertBefore(p.find("tr:eq("+i+") td:first"));$('<td><span class="tree-dnd-icon tree-dnd-no" style="position:static">&nbsp;</span></td>').insertBefore(p.find("tr:eq("+i+") td:first"))});p.find("td").css("vertical-align","middle");p.hide();return p},deltaX:15,deltaY:15,delay:opts.dragDelay,onBeforeDrag:function(e){var draggingRow=getDraggingRow(this);if(opts.onBeforeDrag.call(target,draggingRow)==false){return false}if($(e.target).parent().hasClass("datagrid-cell-check")){return false}if(e.which!=1){return false}},onStartDrag:function(){$(this).draggable("proxy").css({left:-1e4,top:-1e4});var draggingRow=getDraggingRow(this);setValid(draggingRow,false);state.draggingRow=draggingRow;opts.onStartDrag.call(target,draggingRow)},onDrag:function(e){var x1=e.pageX,y1=e.pageY,x2=e.data.startX,y2=e.data.startY;var d=Math.sqrt((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2));if(d>3){$(this).draggable("proxy").show();var tr=opts.finder.getTr(target,parseInt($(this).attr("datagrid-row-index")),"body");$.extend(e.data,{startX:tr.offset().left,startY:tr.offset().top,offsetWidth:0,offsetHeight:0})}this.pageY=e.pageY},onEndDrag:function(e){var dd=$(this).data("draggable").droppables.filter(function(){var dropObj=$(this);if(dropObj.droppable("options").disabled){return false}if(dropObj.hasClass("datagrid-row")&&!dropObj.hasClass("datagrid-row-over")){return false}var p2=dropObj.offset();if(e.pageX>p2.left&&e.pageX<p2.left+dropObj.outerWidth()&&e.pageY>p2.top&&e.pageY<p2.top+dropObj.outerHeight()){return true}else{return false}});var trs=dd.filter(function(){return $(this).hasClass("datagrid-row")});if(trs.length){dd=trs}$(this).data("draggable").droppables=dd},onStopDrag:function(){enableDroppable(disabledDroppingRows);disabledDroppingRows=[];setValid(state.draggingRow,true);opts.onStopDrag.call(target,state.draggingRow)}};var droppableOptions={disabled:false,accept:opts.dropAccept,onDragEnter:function(e,source){if($(this).droppable("options").disabled){return}var dTarget=getDataGridTarget(this);var dOpts=$(dTarget).datagrid("options");var tr=dOpts.finder.getTr(dTarget,null,"highlight");var sRow=getDraggingRow(source);var dRow=getRow(this);if(tr.length&&dRow){cb()}function cb(){if(opts.onDragEnter.call(target,dRow,sRow)==false){$(dTarget).datagrid("clearInsertingFlag");tr.droppable("disable");tr.each(function(){disabledDroppingRows.push(this)})}}},onDragOver:function(e,source){if($(this).droppable("options").disabled){return}if($.inArray(this,disabledDroppingRows)>=0){return}var dTarget=getDataGridTarget(this);var dOpts=$(dTarget).datagrid("options");var tr=dOpts.finder.getTr(dTarget,null,"highlight");if(tr.length){if(!isValid(tr)){setProxyFlag(source,false);return}}setProxyFlag(source,true);var sRow=getDraggingRow(source);var dRow=getRow(this);if(tr.length){var pageY=source.pageY;var top=tr.offset().top;var bottom=tr.offset().top+tr.outerHeight();$(dTarget).datagrid("clearInsertingFlag");dOpts.insertingIndex=tr.attr("datagrid-row-index");if(pageY>top+(bottom-top)/2){tr.addClass("datagrid-row-bottom")}else{tr.addClass("datagrid-row-top")}if(dRow){cb()}}function cb(){if(opts.onDragOver.call(target,dRow,sRow)==false){setProxyFlag(source,false);$(dTarget).datagrid("clearInsertingFlag");tr.droppable("disable");tr.each(function(){disabledDroppingRows.push(this)})}}},onDragLeave:function(e,source){if($(this).droppable("options").disabled){return}setProxyFlag(source,false);var dTarget=getDataGridTarget(this);$(dTarget).datagrid("clearInsertingFlag");var sRow=getDraggingRow(source);var dRow=getRow(this);if(dRow){opts.onDragLeave.call(target,dRow,sRow)}},onDrop:function(e,source){if($(this).droppable("options").disabled){return}var sTarget=getDataGridTarget(source);var dTarget=getDataGridTarget(this);var dOpts=$(dTarget).datagrid("options");var tr=dOpts.finder.getTr(dTarget,null,"highlight");var point=null;var sRow=getDraggingRow(source);var dRow=null;if(tr.length){if(!isValid(tr)){return}point=tr.hasClass("datagrid-row-top")?"top":"bottom";dRow=getRow(tr)}$(dTarget).datagrid("clearInsertingFlag");if(opts.onBeforeDrop.call(target,dRow,sRow,point)==false){return}insert.call(this);opts.onDrop.call(target,dRow,sRow,point);function insert(){var destIndex=parseInt(tr.attr("datagrid-row-index"));if(!point){var indexs=$(sTarget).datagrid("_getRowIndexs",sRow);$(dTarget).datagrid("_appendRows",sRow);$(sTarget).datagrid("_deleteRows",indexs);$(dTarget).datagrid("_setSelections")}else if(dTarget!=sTarget){var index=point=="top"?destIndex:destIndex+1;if(index>=0){var indexs=$(sTarget).datagrid("_getRowIndexs",sRow);$(dTarget).datagrid("_insertRows",{index:index,row:sRow});$(sTarget).datagrid("_deleteRows",indexs);$(dTarget).datagrid("_setSelections")}}else{var dg=$(dTarget);var index=point=="top"?destIndex:destIndex+1;if(index>=0){var indexs=dg.datagrid("_getRowIndexs",sRow);var destIndex=parseInt(tr.attr("datagrid-row-index"));var index=point=="top"?destIndex:destIndex+1;if(index>=0){dg.datagrid("_insertRows",{index:index,row:sRow});for(var i=0;i<indexs.length;i++){if(indexs[i]>index){indexs[i]+=indexs.length}}dg.datagrid("_deleteRows",indexs);dg.datagrid("_setSelections")}}}}}};if(index!=undefined){var trs=opts.finder.getTr(this,index)}else{var trs=opts.finder.getTr(this,0,"allbody")}trs.draggable(draggableOptions);trs.droppable(droppableOptions);setDroppable(target);function setProxyFlag(source,allowed){var icon=$(source).draggable("proxy").find("span.tree-dnd-icon");icon.removeClass("tree-dnd-yes tree-dnd-no").addClass(allowed?"tree-dnd-yes":"tree-dnd-no")}function getRow(tr){if(!$(tr).hasClass("datagrid-row")){return null}var target=$(tr).closest("div.datagrid-view").children("table")[0];var opts=$(target).datagrid("options");return opts.finder.getRow(target,$(tr))}function getDraggingRow(tr){if(!$(tr).hasClass("datagrid-row")){return null}var target=getDataGridTarget(tr);var opts=$(target).datagrid("options");var rows=$(target).datagrid("getRows");for(var i=0;i<rows.length;i++){rows[i]._selected=undefined}if(opts.dragSelection){if($(tr).hasClass("datagrid-row-selected")){var rows=$(target).datagrid("getSelections");$.map(rows,function(row){row._selected=true});return rows}}var row=opts.finder.getRow(target,$(tr));row._selected=$(tr).hasClass("datagrid-row-selected");return row}function setDroppable(target){getDroppableBody(target).droppable(droppableOptions).droppable("enable")}function getDataGridTarget(el){return $(el).closest("div.datagrid-view").children("table")[0]}function getDroppableBody(target){var dc=$(target).data("datagrid").dc;return dc.view}function isValid(tr){var opts=$(tr).droppable("options");if(opts.disabled||opts.accept=="no-accept"){return false}else{return true}}function setValid(rows,valid){var accept=valid?opts.dropAccept:"no-accept";$.map($.isArray(rows)?rows:[rows],function(row){var index=$(target).datagrid("getRowIndex",row);opts.finder.getTr(target,index).droppable({accept:accept})})}})},disableDnd:function(jq){return jq.each(function(){var target=this;var state=$.data(this,"datagrid");var dg=$(this);var opts=state.options;var trs=opts.finder.getTr(this,0,"allbody");trs.draggable("disable");trs.droppable("disable")})}})})(jQuery);var groupview=$.extend({},$.fn.datagrid.defaults.view,{render:function(target,container,frozen){var state=$.data(target,"datagrid");var opts=state.options;var rows=state.data.rows;var fields=$(target).datagrid("getColumnFields",frozen);var table=[];var index=0;var groups=this.groups;for(var i=0;i<groups.length;i++){var group=groups[i];table.push('<div class="datagrid-group" group-index='+i+' style="height:25px;overflow:hidden;border-bottom:1px solid #ccc;">');table.push('<table cellspacing="0" cellpadding="0" border="0" style="height:100%"><tbody>');table.push("<tr>");table.push('<td style="border:0;">');if(!frozen){table.push('<span style="color:#666;font-weight:bold;">');table.push(opts.groupFormatter.call(target,group.fvalue,group.rows));table.push("</span>")}table.push("</td>");table.push("</tr>");table.push("</tbody></table>");table.push("</div>");table.push('<table class="datagrid-btable" cellspacing="0" cellpadding="0" border="0"><tbody>');for(var j=0;j<group.rows.length;j++){var cls=index%2&&opts.striped?'class="datagrid-row datagrid-row-alt"':'class="datagrid-row"';var styleValue=opts.rowStyler?opts.rowStyler.call(target,index,group.rows[j]):"";var style=styleValue?'style="'+styleValue+'"':"";var rowId=state.rowIdPrefix+"-"+(frozen?1:2)+"-"+index;table.push('<tr id="'+rowId+'" datagrid-row-index="'+index+'" '+cls+" "+style+">");table.push(this.renderRow.call(this,target,fields,frozen,index,group.rows[j]));table.push("</tr>");index++}table.push("</tbody></table>")}$(container).html(table.join(""))},onAfterRender:function(target){var opts=$.data(target,"datagrid").options;var dc=$.data(target,"datagrid").dc;var view=dc.view;var view1=dc.view1;var view2=dc.view2;$.fn.datagrid.defaults.view.onAfterRender.call(this,target);if(opts.rownumbers||opts.frozenColumns.length){var group=view1.find("div.datagrid-group")}else{var group=view2.find("div.datagrid-group")}$('<td style="border:0;text-align:center;width:25px"><span class="datagrid-row-expander datagrid-row-collapse" style="display:inline-block;width:16px;height:16px;cursor:pointer">&nbsp;</span></td>').insertBefore(group.find("td"));view.find("div.datagrid-group").each(function(){var groupIndex=$(this).attr("group-index");$(this).find("span.datagrid-row-expander").bind("click",{groupIndex:groupIndex},function(e){if($(this).hasClass("datagrid-row-collapse")){$(target).datagrid("collapseGroup",e.data.groupIndex)}else{$(target).datagrid("expandGroup",e.data.groupIndex)}})})},onBeforeRender:function(target,rows){var opts=$.data(target,"datagrid").options;var groups=[];for(var i=0;i<rows.length;i++){var row=rows[i];var group=getGroup(row[opts.groupField]);if(!group){var fv=row[opts.groupField];if(!fv){fv=""}group={fvalue:fv,rows:[row],startRow:i};groups.push(group)}else{group.rows.push(row)}}function getGroup(fvalue){if(!fvalue){fvalue=""}for(var i=0;i<groups.length;i++){var group=groups[i];if(fvalue.toString()=="[object Object]"){if(fvalue["id"]&&group.fvalue["id"]&&fvalue["id"]==group.fvalue["id"]){return group}}else{if(group.fvalue==fvalue){return group}}}return null}this.groups=groups;var newRows=[];for(var i=0;i<groups.length;i++){var group=groups[i];for(var j=0;j<group.rows.length;j++){newRows.push(group.rows[j])}}$.data(target,"datagrid").data.rows=newRows}});$.extend($.fn.datagrid.methods,{expandGroup:function(jq,groupIndex){return jq.each(function(){var view=$.data(this,"datagrid").dc.view;if(groupIndex!=undefined){var group=view.find('div.datagrid-group[group-index="'+groupIndex+'"]')}else{var group=view.find("div.datagrid-group")}var expander=group.find("span.datagrid-row-expander");if(expander.hasClass("datagrid-row-expand")){expander.removeClass("datagrid-row-expand").addClass("datagrid-row-collapse");group.next("table").show()}$(this).datagrid("fixRowHeight")})},collapseGroup:function(jq,groupIndex){return jq.each(function(){var view=$.data(this,"datagrid").dc.view;if(groupIndex!=undefined){var group=view.find('div.datagrid-group[group-index="'+groupIndex+'"]')}else{var group=view.find("div.datagrid-group")}var expander=group.find("span.datagrid-row-expander");if(expander.hasClass("datagrid-row-collapse")){expander.removeClass("datagrid-row-collapse").addClass("datagrid-row-expand");group.next("table").hide()}$(this).datagrid("fixRowHeight")})}});$.extend($.fn.datagrid.methods,{statistics:function(jq,columns){var opt=$(jq).datagrid("options").columns;var rows=$(jq).datagrid("getRows");var sumShow=false;var avgShow=false;var maxShow=false;var minShow=false;var footerObj=new Array;var footer=new Array;footer["sum"]="";footer["avg"]="";footer["max"]="";footer["min"]="";let excludes;let hideLabel=false;if(undefined!=columns){if(typeof columns=="string"){excludes=columns}else{excludes=columns.columns;hideLabel=columns.hideLabel?true:false}}if(undefined!=excludes){var resultV=excludes.split(",");for(var i=0;i<resultV.length;i++){footer["sum"]=footer["sum"]+'"'+resultV[i]+'":"",';footer["avg"]=footer["avg"]+'"'+resultV[i]+'":"",';footer["max"]=footer["max"]+'"'+resultV[i]+'":"",';footer["min"]=footer["min"]+'"'+resultV[i]+'":"",'}}for(var i=0;i<opt[0].length;i++){var fieldName=opt[0][i].field;if(isStatics(fieldName,"sum")){sumShow=true;footer["sum"]=footer["sum"]+sum(fieldName)+","}else{footer["sum"]=footer["sum"]+'"'+fieldName+'":"",'}if(isStatics(fieldName,"avg")){avgShow=true;footer["avg"]=footer["avg"]+avg(opt[0][i].field)+","}else{footer["avg"]=footer["avg"]+'"'+fieldName+'":"",'}if(isStatics(fieldName,"max")){maxShow=true;footer["max"]=footer["max"]+max(opt[0][i].field)+","}else{footer["max"]=footer["max"]+'"'+fieldName+'":"",'}if(isStatics(fieldName,"min")){minShow=true;footer["min"]=footer["min"]+min(opt[0][i].field)+","}else{footer["min"]=footer["min"]+'"'+fieldName+'":"",'}}if(footer["sum"]!=""){var tmp="{"+footer["sum"].substring(0,footer["sum"].length-1)+"}";var obj=eval("("+tmp+")");if(!hideLabel){if(obj[opt[0][0].field]==undefined){footer["sum"]+='"'+opt[0][1].field+'":"<b>当页合计:</b>"';obj=eval("({"+footer["sum"]+"})")}else{obj[opt[0][1].field]="<b>当页合计:</b>"+obj[opt[0][0].field]}}if(sumShow){footerObj.push(obj)}}if(footer["avg"]!=""){var tmp="{"+footer["avg"].substring(0,footer["avg"].length-1)+"}";var obj=eval("("+tmp+")");if(!hideLabel){if(obj[opt[0][0].field]==undefined){footer["avg"]+='"'+opt[0][1].field+'":"<b>当页均值:</b>"';obj=eval("({"+footer["avg"]+"})")}else{obj[opt[0][1].field]="<b>当页均值:</b>"+obj[opt[0][0].field]}}if(avgShow){footerObj.push(obj)}}if(footer["max"]!=""){var tmp="{"+footer["max"].substring(0,footer["max"].length-1)+"}";var obj=eval("("+tmp+")");if(!hideLabel){if(obj[opt[0][0].field]==undefined){footer["max"]+='"'+opt[0][1].field+'":"<b>当页最大值:</b>"';obj=eval("({"+footer["max"]+"})")}else{obj[opt[0][1].field]="<b>当页最大值:</b>"+obj[opt[0][0].field]}}if(maxShow){footerObj.push(obj)}}if(footer["min"]!=""){var tmp="{"+footer["min"].substring(0,footer["min"].length-1)+"}";var obj=eval("("+tmp+")");if(!hideLabel){if(obj[opt[0][0].field]==undefined){footer["min"]+='"'+opt[0][1].field+'":"<b>当页最小值:</b>"';obj=eval("({"+footer["min"]+"})")}else{obj[opt[0][1].field]="<b>当页最小值:</b>"+obj[opt[0][0].field]}}if(minShow){footerObj.push(obj)}}if(footerObj.length>0){$(jq).datagrid("reloadFooter",footerObj)}function isStatics(fieldName,statics){if($(jq).find("th[field='"+fieldName+"']").attr(statics)){return true}let result=false;$.each(opt[0],function(i,e){if(e.field==fieldName&&e[statics]){result=true;return}});return result}function sum(filed){var sumNum=0;for(var i=0;i<rows.length;i++){sumNum+=Number(rows[i][filed])}return'"'+filed+'":"'+sumNum.toFixed(2)+'"'}function avg(filed){var sumNum=0;for(var i=0;i<rows.length;i++){sumNum+=Number(rows[i][filed])}return'"'+filed+'":"'+(sumNum/rows.length).toFixed(2)+'"'}function max(filed){var max=0;for(var i=0;i<rows.length;i++){if(i==0){max=Number(rows[i][filed])}else{max=Math.max(max,Number(rows[i][filed]))}}return'"'+filed+'":"'+max+'"'}function min(filed){var min=0;for(var i=0;i<rows.length;i++){if(i==0){min=Number(rows[i][filed])}else{min=Math.min(min,Number(rows[i][filed]))}}return'"'+filed+'":"'+min+'"'}}});